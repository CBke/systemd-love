From c6a997b2a3d9112fb8b249e7b77f37ab170ed838 Mon Sep 17 00:00:00 2001
From: Fabio Erculiani <lxnay@sabayon.org>
Date: Thu, 25 Apr 2013 16:55:56 +0100
Subject: [PATCH 2/2] linuxrc: run the debug shell multiple times, add a hook
 before switch_root

---
 defaults/initrd.scripts | 1 +
 defaults/linuxrc        | 5 ++++-
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/defaults/initrd.scripts b/defaults/initrd.scripts
index 365eeca..970d3e7 100755
--- a/defaults/initrd.scripts
+++ b/defaults/initrd.scripts
@@ -1055,6 +1055,7 @@ rundebugshell() {
 	if [ -n "$DEBUG" ]
 	then
 		good_msg 'Starting debug shell as requested by "debug" option.'
+		good_msg "Stopping by: ${1}"
 		do_rundebugshell
 	fi
 }
diff --git a/defaults/linuxrc b/defaults/linuxrc
index f6f91f7..03cbf1d 100755
--- a/defaults/linuxrc
+++ b/defaults/linuxrc
@@ -423,7 +423,7 @@ mkdir -p "${NEW_ROOT}"
 CHROOT="${NEW_ROOT}"
 
 # Run debug shell if requested
-rundebugshell
+rundebugshell "before setting up the root filesystem"
 
 if [ "${CDROOT}" = '1' ]
 then
@@ -936,6 +936,9 @@ then
 	bad_msg "ERROR: your real /dev is missing tty1, required for splash"
 fi
 
+# Run debug shell if requested
+rundebugshell "before entering switch_root"
+
 exec /sbin/switch_root -c "/dev/console" "${CHROOT}" "${REAL_INIT:-/sbin/init}" "${INIT_OPTS}"
 
 # If we get here, something bad has happened
-- 
1.8.1.5

